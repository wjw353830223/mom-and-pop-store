<template>
    <ui-page top="0"  page-load="{{ pageLoad }}">
        <!-- 头部 -->
        <!-- navbar -->
      <!-- <ui-nav-bar slot="nav-bar" class="nav-bar">
        <ui-row height="46">
          <ui-col vertical-align="middle" align="center" width="40" bindtap="navigateBack">
              <ui-icon type="arrow-left" color="#ffffff" size="18"></ui-icon>
          </ui-col>
          <ui-col vertical-align="middle" bindtap="showFullScreenSearch">
            
          </ui-col>
          <ui-col width="15">
          </ui-col>
        </ui-row>
      </ui-nav-bar> -->
      <!--  -->
        
        
        <!-- 商品 -->
        <ui-view class="container">
          <ui-row>
            <!-- tab -->
            <ui-col border-right width="100">
              <ui-v-tabs
                height="{{ WIN_HEIGHT-201}}"
                index="{{ current }}"
                probe=1
                bindchange="handleChange($event, 'current')">
                <ui-v-tab ui:for="{{ tabItems }}">
                  {{ item.name }}
                </ui-v-tab>
              </ui-v-tabs>
            </ui-col>
            <!-- 商品列表 -->
            <ui-col class="goods-list">
              <ui-scroll-view height="{{ WIN_HEIGHT-10}}" bindscroll="scroll($event, 'current')" probe="2" background-color="#fff" scroll-y scroll-into-view="{{toView}}">
                <ui-view ui:for="{{goodsList}}" ui:for-index="index" ui:for-item="goodsItem" id="id{{ index }}" >
                  <ui-divider>{{goodsItem.name}}</ui-divider>
                  <ui-row height="70" border-bottom ui:for="{{goodsItem.items}}" ui:for-item="item" ui:for-index="index" bindtap="productTo(item.id)">
                    <ui-col vertical-align="middle" width="70" space-left="10">
                      <ui-image class="imgbox" src="{{ item.image }}" width="70" height="70"></ui-image>
                    </ui-col>
                    <ui-col vertical-align="middle" space-left="16">
                      <ui-view class="goods-list-right">
                        <ui-text block class="t1">{{ item.name }}</ui-text>
                        <ui-text block class="t2">{{ item.introduction }}</ui-text>
                        <ui-text class='t3'>优惠价：¥{{ item.preferential_price }}</ui-text>
                      </ui-view>
                    </ui-col>
                  </ui-row>
                </ui-view>
              </ui-scroll-view>
            </ui-col>
          </ui-row>

        </ui-view>
    </ui-page>
  </template>


<script>
export default {
  config: {
    navigationBarTitleText: '首页',
    "navigationStyle": "custom",
    "disableScroll":true,
    navigationBarTextStyle: 'white'
  },
  data () {
    return {
      WIN_HEIGHT:ui.WIN_HEIGHT,
      DEFAULT_HEADER_HEIGHT:ui.DEFAULT_HEADER_HEIGHT,
      current: 0,
      page:0,
      toView: '',
      tabItems: [],
      goodsList: [],
      pageLoad:{
        trigger: 'always',//每次进入页面都触发
        handle: () => {
          let tid = this.getTableId();
        }
      }
    }
  },
  methods: {
    scroll (y, key) {
      if (y > 0) {
        // //滚动容器没有滚动到最上方
        this.scrollTop = '1'
      } else {
        // 滚动容器滚动到最上方
        this.scrollTop = '0'
      }
      let top = Math.abs(y)
      var length = this.goodsList.length
      for (var i = 0; i <= length - 1; i++) {
        if (top >= this.goodsList[i].top - 10) {
          this.current = i
        }
      }
    },
    navigateBack () {
      ui.navigateBack()
    },
    callWaiter(){
      let _self = this;
      let token = ui.getStorageSync('token');
      ui.showConfirm({
        content: `<p style="text-align:center">呼叫服务员，确定吗？</p>`,
        success(result) {
          if (result.confirm) {
            let tid=0;
            if(tid){
              _self
              .fetchs("/api/order/call_waiter", "POST", {
                token:token,
                tid:tid
              })
              .then(res => {
                ui.showToast({ title: res.data.msg, icon: 'success', duration: 3000})
              })
              .catch(err => {
                
              });
            }
          }
        }
      });
    },
    getProducts(oid){
      this.fetchs("/api/product/products", "POST", {
        page: this.page,
        oid: oid,
        random_str:"/api/product/products"
      }).then(res => {
        this.tabItems = res.data.result.classify;
        this.goodsList = res.data.result.menus;
      });
      let arr = []
      let sum = 0
      let length = this.goodsList.length
      for (var i = 0; i < length; i++) {
        arr.push(this.goodsList[i].items.length)
        if (i === 0) {
          this.goodsList[i].top = 0
        } else {
          sum += arr[i - 1]
          this.goodsList[i].top = 70 * sum + 32 * i
        }
      }
    },
    getTableId(){
      let _self = this;
      let tid = ui.getStorageSync('tid');
      let oid = ui.getStorageSync('oid');
      if(!tid || !oid){
        import(`#/pages/table.ui`).then((content) => {
          ui.showDialog({
              content: content,
              statusBarColor: 'black',
              // 接收ui.hideDialog回传的数据
              onHide: (data) => {
                tid = data.tid;
                oid = data.oid;
                ui.setStorageSync('tid',tid);
                ui.setStorageSync('oid',oid);
                if(oid!=0){
                   _self.getProducts(oid);
                }
              }
          })
        })
      }else{
         _self.getProducts(oid);
      }
      return tid;
    },
    handleChange (index, key) {
      this.toView = 'id' + index
      this[key] = index
    },
    productTo(mid) {
      ui.navigateTo({
        url: '/pages/detail' + '?mid=' + mid
      })
    },
  },
  mounted () {
    // let token = ui.getStorageSync('token')
    // if(token){
    //   this.estiblashWs()
    // }
  }
  
}
</script>

<style lang="less">
.nav-bar {
  .mix-1px(0, 0, 1, 0, #ccc);
  background-color: #9a493f;
  .search {
    width: 100%;
    line-height: 30px;
    text-align: center;
    background-color: #f5f5f5;
    border-radius: 8rpx;
    color: #888888;
    font-size: 14px;
  }
}
.blur-box{
  position:absolute;
  top:0;
  height:135px;
  width:100%;
}
.top_box{
  height:89px;
}
.nav{
  z-index:9;
}
.nav2{
  z-index:9;
  .nav_right{
    color:#fff;
    font-size:12px;
    line-height:24px;
    margin-top:3px;
    .t1{
      font-size:16px;
    }
  }
  .col-w{
    flex:0 0 100px;
    top:22px;
    .imgbox{
      box-shadow: 0px 5px 10px -2px #9a9a9a;
      width:100%;
      border-radius: 5px;
      overflow: hidden;
      .ui-image{
        width:100%;
      }
    }
  }
}

.tabs{
  margin-top:20px;
  .mix-1px(0, 0, 1, 0, #ccc);
}

.goods-list{
  .imgbox{
    .ui-image{
      width:100%;
    }
  }
  .goods-list-right{
    font-size:12px;
    .t1{
      font-size:14px;
    }
    .t3{
      color:#e60012
    }
  }
}

</style>
